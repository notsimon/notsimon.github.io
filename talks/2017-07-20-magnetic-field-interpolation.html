<!DOCTYPE html>

<meta charset="utf-8">
<title>Interpolation of the magnetic field for drift correction</title>
<link href="../css/talk.css" rel="stylesheet" type="text/css" />
<link href="../css/katex.min.css" rel="stylesheet" type="text/css" />

<section id="title" class="inverse">
  <div class="middle center">
    <div class="title">Interpolation of the magnetic field for drift correction</div>
  
    <div class="subtitle">Interpolation du champ magnétique pour la correction de dérive</div>
  
    <div class="author">Simon Guillot</div>
  </div>
  <div class="date">July 20, 2017</div>
</section>

<section id="sevenhugs" class="slide level1">
<h1>Sevenhugs</h1>
<figure>
<img src="../media/sevenhugs/pointing.gif" style="width:90.0%" />
</figure>
<ul>
<li>To track its position and orientation in the room, the remote merges:
<ul>
<li>Measurements from a set of embedded sensors: a gyroscope, an accelerometer, a magnetometer</li>
<li>The distances to three beacons and its charging base</li>
</ul></li>
<li>During setup, the user places its real and virtual objects using the remote</li>
</ul>
</section>
<section id="indoor-usage-of-a-magnetometer" class="slide level1">
<h1>Indoor usage of a magnetometer</h1>
<figure>
<img src="../media/map.svg" alt="Variations in color represent variations in inclination" style="width: 70%; margin: -2.5em 0" /><figcaption>Variations in color represent variations in inclination</figcaption>
</figure>
<ul>
<li>Important variations of the intensity and direction in the magnetic field</li>
<li>The magnetometer must be recalibrated when exposed to strong fields</li>
</ul>
</section>
<section id="estimation-of-the-magnetic-field" class="slide level1">
<h1>Estimation of the magnetic field</h1>
<figure>
<img src="../media/magnetic-field-interpolation/map_measurements.svg" style="width:80.0%" />
</figure>
<p>The model learns from a set of readings <span class="math inline">D^\star = \{ (x_i^\star, y_i^\star) | i \in [1..N] \}</span> where</p>
<ul>
<li><span class="math inline">y^\star \in \mathbb{R}^3</span> is the magnetometer reading transformed to be independent of the orientation of the device</li>
<li><span class="math inline">x^\star \in \mathbb{R}^3</span> its associated position</li>
</ul>
<p>We are looking for an approximation <span class="math inline">B</span> of the field such that <span class="math display">\displaystyle 
B(x^\star) \approx y^\star
</span></p>
</section>
<section id="estimation-of-the-magnetic-field-1" class="slide level1">
<h1>Estimation of the magnetic field</h1>
<figure>
<img src="../media/magnetic-field-interpolation/map_ground_truth.svg" style="width:80.0%" />
</figure>
<p>Given a (new) position, the model is expected to predict the value of the magnetic field.</p>
<hr>
</hr>
<p><strong>Difficulty:</strong> How to generalize well enough to be accurate in unexplored areas ?</p>
</section>
<section id="a-priori-knowledge" class="slide level1">
<h1>A priori knowledge</h1>
<p>Electromagnetic phenomena are governed by the four Maxwell’s equations, two involve the magnetic field.</p>
<div class="next">
<p><span class="math display">\displaystyle 
  \nabla \cdot B = 0
</span></p>
<p><strong>The magnetic field is divergence-free</strong>: magnetic monopoles do not exist.</p>
</div>
<div class="next" style="margin-top: 3em">
<p><span class="math display">\displaystyle 
  \nabla \times B = \mu_0 \left(J + \epsilon_0 \frac{\partial E}{\partial t}\right)
</span></p>
<p>Around a closed loop, it depends on the electric current.</p>
</div>
<div class="next">
<p>We are assuming:</p>
<ul>
<li>no free current in the air</li>
<li>no time-dependent effects due to moving charge</li>
</ul>
<p>Ampere’s circuital law reduces to:</p>
<p><span class="math display">\displaystyle 
  \nabla \times B = 0
</span></p>
<p><strong>The magnetic field is irrotational.</strong></p>
</div>
</section>
<section id="the-magnetic-potential" class="slide level1">
<h1>The magnetic potential</h1>
<p>An irrotational vector field can be represented as <em>the gradient of a scalar field</em> <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<p><span class="math display">\displaystyle 
  B(x) = -\nabla_x \psi(x)
</span></p>
<div class="next">
<p>Our goal is now to find a function <span class="math inline">\psi</span></p>
<ul>
<li>in <span class="math inline">\mathbb{R}^3 \mapsto \mathbb{R}</span></li>
<li>differentiable w.r.t the position <span class="math inline">x</span></li>
</ul>
</div>
<figure>
<img src="../media/magnetic-field-interpolation/potential_example.svg" alt="A scalar field and its associated gradient" style="width:80.0%" /><figcaption>A scalar field and its associated gradient</figcaption>
</figure>
</section>
<section id="proposed-model" class="slide level1">
<h1>Proposed model</h1>
<figure>
<img src="../media/magnetic-field-interpolation/model_anchors.svg" alt="The model is supported by a set of anchors points" style="width:45.0%" /><figcaption>The model is supported by a set of anchors points</figcaption>
</figure>
<p>Interpolation from a set of <span class="math inline">K</span> anchor points <span class="math inline">M = \{(c_k, w_k) | k \in [1, K]\}</span> where</p>
<ul>
<li><span class="math inline">c_k</span> is the position of the anchors in <span class="math inline">\mathbb{R}^3</span></li>
<li><span class="math inline">w_k</span> its associated scalar value</li>
</ul>
</section>
<section id="proposed-model-1" class="slide level1">
<h1>Proposed model</h1>
<figure>
<img src="../media/magnetic-field-interpolation/model_interpolation.svg" alt="The model is supported by a set of anchors points" style="width:45.0%" /><figcaption>The model is supported by a set of anchors points</figcaption>
</figure>
<p>We define <span class="math inline">\psi</span> as</p>
<p><span class="math display">\displaystyle 
  \psi(x) = \sum_{k=1}^K w_k \phi(x, c_k)
</span></p>
<p>where <span class="math inline">\phi</span> gives a weight to the anchors depending on their distance.</p>
</section>
<section id="proposed-model-2" class="slide level1">
<h1>Proposed model</h1>
<p><span class="math display">\displaystyle 
\begin{aligned}
  B(x)    &amp;= \nabla_x \psi(x) \\\\
          &amp;= \sum_{k=1}^K w_k \nabla_x \phi(x, c_k)
\end{aligned}
</span></p>
<p>We chose <span class="math inline">\phi</span> to be a Gaussian: <span class="math display">\displaystyle 
  \phi(x, c_k) = e^{-\frac{||x - c_k||^2}{2 \sigma^2}}
</span></p>
<p>its gradient is</p>
<p><span class="math display">\displaystyle 
  \nabla_x \phi(x, c_k) = \frac{c_k - x}{\sigma^2}
                          e^{-\frac{||x - c_k||^2}{2 \sigma^2}}
  \quad \in \mathbb{R}^3
</span></p>
<div class="next">
<hr style="margin-bottom: 1em">
</hr>
<figure>
<img src="../media/magnetic-field-interpolation/rbf.svg" width="240" />
</figure>
</div>
</section>
<section id="reducing-to-a-linear-optimization-problem" class="slide level1">
<h1>Reducing to a linear optimization problem</h1>
<p>If we <strong>do not fit the positions <span class="math inline">c_k</span> of the anchors</strong>, <span class="math inline">B</span> can then be written</p>
<p><span class="math display">\displaystyle 
  B = H \cdot w
</span></p>
<p>where <span class="math inline">H</span> is the <span class="math inline">3 \times K</span> matrix</p>
<p><span class="math display">\displaystyle 
H =
\begin{bmatrix}
  \nabla_x \phi(x, c_1) &amp; \cdots &amp; \nabla_x \phi(x, c_K)
\end{bmatrix}
</span></p>
<p>and <span class="math inline">w</span> the column vector</p>
<p><span class="math display">\displaystyle 
w =
\begin{bmatrix}
  w_1 \\
  \vdots \\
  w_K
\end{bmatrix}
</span></p>
</section>
<section id="kalman-filters" class="slide level1">
<h1>Kalman filters</h1>
<ul>
<li>Optimal for <strong>linear optimization problems</strong> involving Gaussian noises</li>
<li>Estimate a state <span class="math inline">w</span> with its associated covariance matrix <span class="math inline">P</span></li>
</ul>
<div class="algorithm">
<h4 id="algorithm-outline">Algorithm outline</h4>
<ol type="1">
<li><strong>Predict</strong>
<ul>
<li>Use a “transition model” to forward the estimated state in time</li>
</ul></li>
<li><strong>Update</strong>
<ul>
<li>Project the estimated state into the measurement space using an “observation model”</li>
<li>Compare to the actual measurement</li>
<li>Correct the estimation</li>
</ul></li>
</ol>
</div>
<p>Advantages</p>
<ul>
<li>Online estimation of the parameters, each measurement is observed only <strong>once</strong></li>
<li>Fine-grained uncertainty on the measurements and estimation</li>
</ul>
</section>
<section id="estimation-of-the-potential-using-a-kalman-filter" class="slide level1">
<h1>Estimation of the potential using a Kalman filter</h1>
<div class="algorithm">
<h4 id="for-each-measurement-x-y">For each measurement <span class="math inline">(x, y)</span></h4>
<ol type="1">
<li>Compute the <span class="math inline">H</span> matrix for the current position <span class="math inline">x</span></li>
<li>Compute the residual <span class="math inline">z</span> between the true and estimated measurements, its associated covariance <span class="math inline">S</span> and the Kalman gain <span class="math inline">K</span> using</li>
</ol>
<p><span class="math display">\displaystyle 
\begin{aligned}
z &amp;= y - H w \\
S &amp;= R + H P H^\top \\
K &amp;= P H^\top S^{-1} \\
\end{aligned}
</span></p>
<ol start="3" type="1">
<li>Update the state <span class="math inline">w</span> and its covariance <span class="math inline">P</span> with</li>
</ol>
<p><span class="math display">\displaystyle 
\begin{aligned}
w &amp;\leftarrow w + K z \\
P &amp;\leftarrow (I - K H) P
\end{aligned}
</span></p>
</div>
<ul>
<li><span class="math inline">S \in \mathcal{M}^{3\times3}</span>, its inverse is easy to compute</li>
<li><span class="math inline">H</span> grows linearly with the number of anchor points, <span class="math inline">P</span> quadratically</li>
</ul>
</section>
<section id="initial-results" class="slide level1">
<h1>Initial results</h1>
<ul>
<li>Resolution and sigma of 25cm</li>
<li>Addition of a bias – a linear function of the position when viewed as a potential</li>
</ul>
<center>
<video width="72%" controls>
<source src="../media/magnetic-field-interpolation/model_learning.mp4" type="video/mp4"> Your browser does not support the video tag.
</video>
</center>
</section>
<section id="initial-results-1" class="slide level1">
<h1>Initial results</h1>
<ul>
<li>Resolution and sigma of 25cm</li>
<li>Addition of a bias – a linear function of the position when viewed as a potential</li>
</ul>
<figure>
<img src="../media/magnetic-field-interpolation/model_confidence.svg" alt="Model confidence, using the anchors variance" style="width:90.0%" /><figcaption>Model confidence, using the anchors variance</figcaption>
</figure>
</section>
<section id="conclusion" class="slide level1">
<h1>Conclusion</h1>
<p>Summary:</p>
<ul>
<li>Modelisation of a magnetic potential instead of the vector field</li>
<li>Continuous interpolation over a set of chosen points</li>
<li>Inclusion of a second law of Maxwell using a regularization</li>
</ul>
<p>Novelty of the method:</p>
<ul>
<li>Usage of an attention mechanism with a grid of potentials</li>
<li>Implemention in a Kalman filter</li>
</ul>
</section>
<section id="non-linear-version" class="slide level1">
<h1>Non-linear version</h1>
<h2 id="optimization-by-stochastic-gradient-descent">Optimization by stochastic gradient descent</h2>
<p>We are looking for the function <span class="math inline">\psi</span> that minimizes the loss</p>
<p><span class="math display">\displaystyle 
  \mathcal{L} = \sum_{i=1}^N \delta(\nabla \psi(x_i^\star), y_i^\star)
</span></p>
<p>where <span class="math inline">\delta \in (\mathbb{R}^3, \mathbb{R}^3) \mapsto \mathbb{R}</span> is a measurement of the error.</p>
<p>Let <span class="math inline">\theta = (w_1, \cdots, w_K, c_1, \cdots, c_K)^\top</span>, to minimize <span class="math inline">\mathcal{L}_\psi</span>, update iteratively <span class="math inline">\theta</span> using</p>
<p><span class="math display">\displaystyle 
\theta \leftarrow \theta - \epsilon \nabla_\theta \delta(\nabla \psi(x^\star), 
y^\star)
</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\epsilon</span> is a constant controling the learning rate</li>
<li><span class="math inline">(x^\star, y^\star)</span> is an element of <span class="math inline">S^\star</span> chosen at random</li>
</ul>
</section>
<section id="constraint-on-the-divergence" class="slide level1">
<h1>Constraint on the divergence</h1>
<p><span class="math display">\displaystyle 
\begin{aligned}
\nabla \cdot B(x) &amp;= \nabla \cdot \nabla \psi(x) \\ \\
                  &amp;= \sum_{k=1}^K w_k \nabla_x \cdot \nabla_x \phi(x, c_k)
\end{aligned}
</span></p>
<p>which can be rewritten using the scalar Laplacian:</p>
<p><span class="math display">\displaystyle 
\nabla \cdot B(x) = \sum_{k=1}^K w_k \Delta_x \phi(x, c_k)
</span></p>
<ul>
<li>As a regularizer during a SGD, the loss becomes <span class="math display">\displaystyle 
\mathcal{L} = \sum_{i=1}^N \delta(\nabla \psi(x_i^\star), y_i^\star)
+ mean_j\left(\nabla \cdot B(x_j)\right)
</span></li>
<li>As an observation in the Kalman filter: the model is expected to produce a of zero for a number of random positions.</li>
</ul>
</section>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Niklas Wahlström et al., “Modeling magnetic fields using Gaussian Processes”, <em>2013 International Conference on Acoustics, Speech and Signal Processing (ICASSP)</em><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Arno Solin et al., “Modeling and interpolation of the ambient magnetic field by Gaussian processes”, <em>arXiv:1509.04634</em><a href="#fnref2">↩</a></p></li>
</ol>
</section>

<div id="progress-bar"></div>

<script src="../scripts/dzslides.js"></script>
<script src="../scripts/katex.min.js"></script>
<script>
  function loadKatex() {
      var elements = document.getElementsByClassName("math");
      Array.prototype.forEach.call(elements, function(e) {
          var str = e.innerHTML.replace(/&amp;/g, "&")
          katex.render(str, e);
      });
  };

  window.onload = function() {
    loadDz();
    loadKatex();
  }
</script>
