<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>N-dimensional arrays in C | Simon Guillot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/katex.min.css">
  <link href="../atom.xml" type="application/atom+xml" rel="alternate">
</head>
<body>
  <nav>
    <a href="../">Home</a>
    <a href="../blog.html">Blog</a>
    <a href="../about.html">About</a>
    <a href="../cv.html">CV</a>
  </nav>
  <div class="profile">
    <img src="../media/avatar.jpg">
    <h1>Simon Guillot</h1>
    <p class="description">
      A man who travels with the address of his blog on his cap
    </p>
    <p class="accounts">
      <a href="https://github.com/notsimon">
        <svg class="icon"><use xlink:href="/media/fa-brands.svg#github-alt"></use>github</svg>
      </a>
      <a href="https://www.linkedin.com/in/simon-guillot-302567184">
        <svg class="icon"><use xlink:href="/media/fa-brands.svg#linkedin"></use>line</svg>
      </a>
      <a href="https://m.me/simon.gllt">
        <svg class="icon"><use xlink:href="/media/fa-brands.svg#facebook-messenger"></use>messenger</svg>
      </a>
      <a href="../">
        <svg class="icon"><use xlink:href="/media/fa-brands.svg#line"></use>line</svg>
      </a>
    </p>
  </div>
  <div class="container">
    <main>
      <style>
  .profile {
    display: none;
  }

  article {
    margin-top: 10vh;
  }
</style>

<article>
  <header>
    <h1>N-dimensional arrays in C</h1>
    
    <p><time>April  9, 2012</time></p>
    
  </header>

  <section class="content">
    <p>The grammar of C is messy and some constructions can be counter-intuitive for beginners: this is the case of multidimensional arrays (non-programmers would call them tensors).</p>
<h2 id="introduction">Introduction</h2>
<p>Someone new to low-level programming would be tempted to declare arrays with multiple dimensions in the following way:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="dt">float</span>*** make_3d_float_array(<span class="dt">size_t</span> x, <span class="dt">size_t</span> y, <span class="dt">size_t</span> z) {
    <span class="dt">float</span>*** A = malloc(x*<span class="kw">sizeof</span>(<span class="dt">float</span>**));

    <span class="cf">for</span> (...) {
        A[i] = malloc(... <span class="co">// I think you know the rest...</span></code></pre></div>
<p>Even though the syntax for accessing cells is the same as for static arrays, that’s not the best thing to do: unless you’re planning to replace entire rows or planes more often than you do random accesses, this is inefficient. We need contiguous arrays without having to explicitly compute the indexes.</p>
<p>While learning C and experimenting with metaprogramming, I wrote <a href="2012-04-09-c-ndarrays/ndarray.h">a few helpers</a> using the preprocessor for dynamic multidimensional arrays. If you take a look at it without much knowledge of the C preprocessor, you’ll probably see it as mostly voodoo. Fortunately C99 comes with syntactic sugar that makes this unnecessary. <strong>Read on !</strong></p>
<h2 id="static-arrays">Static arrays</h2>
<p>As a reminder, static arrays means we are putting the size of the array in its type. A static 2D arrays of integers can be declared and used as such:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="dt">void</span> foo(<span class="dt">int</span> x[<span class="dv">4</span>][<span class="dv">2</span>]) {
    <span class="co">// Do something with x.</span>
}

<span class="dt">int</span> main() {
    <span class="dt">int</span> x[<span class="dv">4</span>][<span class="dv">2</span>];

    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="kw">sizeof</span>(x) / <span class="kw">sizeof</span>(x[<span class="dv">0</span>]); i++)
        <span class="cf">for</span> (<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; <span class="kw">sizeof</span>(x) / <span class="kw">sizeof</span>(x[<span class="dv">0</span>][<span class="dv">0</span>]); j++)
            x[i][j] = rand();

    foo(x);
    <span class="co">// Don't be fooled by the syntax of foo's argument,</span>
    <span class="co">// there's no copy of x involved!</span>

    <span class="cf">return</span> <span class="dv">0</span>;
}</code></pre></div>
<p>Although the syntax may be deceiving, <strong>the array is not copied when calling the function</strong>. And there’s no way to ask for an implicit copy.</p>
<p>What about dynamic arrays, for which the size may not be known at compile time ?</p>
<h2 id="proper-dynamic-arrays">Proper dynamic arrays</h2>
<p>In C99, variable length arrays can be declared and allocated as follow:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="dt">int</span> m = rand() % <span class="dv">10</span> + <span class="dv">1</span>;
<span class="dt">int</span> n = rand() % <span class="dv">10</span> + <span class="dv">1</span>;

printf(<span class="st">&quot;m = %d, n = %d</span><span class="sc">\n</span><span class="st">&quot;</span>, m, n);

<span class="dt">int</span> x[m][n];
<span class="dt">int</span> (*y)[n] = malloc(m * n * <span class="kw">sizeof</span>(y[<span class="dv">0</span>][<span class="dv">0</span>]));
<span class="dt">int</span> (*z)[m][n] = malloc(<span class="kw">sizeof</span>(*z));</code></pre></div>
<p><code>x</code> is a dynamic (i.e. variable-length) array allocated on the stack. <code>y</code> and <code>z</code> are both pointers to chunks of memory allocated in the heap (which are the size of <code>x</code>) but the semantic slightly differs between the two: the type of the data <code>y</code> points to is <em>an array of <code>n</code> integers</em>, while <code>z</code> points to <em>an array of <code>m</code> arrays of <code>n</code> integers</em>.</p>
<p>If you’re not comfortable with pointer arithmetic, you may want to read <a href="http://www.cs.umd.edu/class/sum2003/cmsc311/Notes/BitOp/pointer.html">this tutorial</a>.</p>
<p>Cell accesses are written as such:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">x[i][j] = <span class="dv">42</span>;
y[i][j] = <span class="dv">42</span>;
(*z)[i][j] = <span class="dv">42</span>; <span class="co">// same as z[0][i][j] ;)</span></code></pre></div>
<p>Even though the semantic of <code>z</code> is, in some way, closer to what we’re expressing, its usage is less practical.</p>
<p>How can we write functions taking dynamic arrays as arguments ? This is were the real syntax tricks hide: we can put the lengths as arguments and use them in the type of the array. For more details on it, read this <a href="https://gcc.gnu.org/onlinedocs/gcc/Variable-Length.html">GCC man page</a>.</p>
<p>In plain C99:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="dt">void</span> foo(<span class="dt">int</span> m, <span class="dt">int</span> n, <span class="dt">int</span> x[m][n]) {
    <span class="co">// Do something with x.</span>
}

<span class="co">// ...</span>

foo(m, n, x);
foo(m, n, y);
foo(m, n, *z);</code></pre></div>
<p>Again, the arrays are not copied.</p>
<p>Finally, GCC provides an elegant extension to put the size arguments after the array, which may lead to more readable code in some cases:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="dt">void</span> bar(<span class="dt">int</span> m, <span class="dt">int</span> n; <span class="dt">int</span> x[m][n], <span class="dt">int</span> m, <span class="dt">int</span> n) {
    <span class="co">// Do something with x.</span>
}

<span class="co">// ...</span>

bar(x, m, n);</code></pre></div>
<p>A full working example of this is available <a href="2012-04-09-c-ndarrays/arrays.c">here</a>.</p>
  </section>
</article>

<script src="../scripts/katex.min.js"></script>
<script>
  window.onload = function() {
      var elements = document.getElementsByClassName("math");
      Array.prototype.forEach.call(elements, function(e) {
          var str = e.innerHTML.replace(/&amp;/g, "&")
          katex.render(str, e);
      });
  };
</script>

    </main>
  </div>
  <footer>
  </footer>
</body>
</html>
